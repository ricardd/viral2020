---
title: "Notebook of COVID-19 analyses"
author: "Daniel Ricard (daniel.ricard@gmail.com)"
date: '`r paste0("Last modified timestap: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"))`'
output: html_notebook
---

# Context
Notes about analyses of COVID-19 data. Inspired by [an article on Towards Data Science](https://towardsdatascience.com/visualize-the-pandemic-with-r-covid-19-c3443de3b4e4)

# Worldwide cases
Using information made available from the [European Centre for Disease Prevention and Control](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide) and updated on a daily basis. There are likely other sources that are updated more regularly (e.g. the many sources used by [worldometers](https://www.worldometers.info/coronavirus/) uses), but this is a decent starting point.


```{r}
## this is copied and pasted from the ECDC website

#these libraries need to be loaded
library(utils)
library(httr)

#download the dataset from the ECDC website to a local temporary file
GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))

#read the Dataset sheet into “R”. The dataset will be called "data".
data <- read.csv(tf)
names(data)[1] <- "dateRep"
## DR
data$dateRep <- as.Date(data$dateRep, format="%d/%m/%Y") ## DR, incoming data is formatted day/month/year and was not recognised correctly as a date
## compute the cumulative number of cases by country
## compute the cumulative number of fatalities by country
library(dplyr)
df <- data[order(data$countriesAndTerritories, data$dateRep),] %>% group_by(countriesAndTerritories) %>% mutate(cumsum.cases = cumsum(cases)) %>% mutate(cumsum.deaths = cumsum(deaths))
df$death.rate.percent <- 100*(df$cumsum.deaths / df$cumsum.cases)
df$cases.per.e06 <- (df$cumsum.cases / df$popData2018)*1E06
df$deaths.per.e06 <- (df$cumsum.deaths / df$popData2018)*1E06
```

```{r}
for.kable <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 arrange(desc(cumsum.cases))
```

There were `r format(sum(for.kable$cumsum.cases),big.mark=",")` confirmed cases and `r format(sum(for.kable$cumsum.deaths),big.mark=",")` deaths as this document was generated using the data obtained from the ECDC (HTML generated `r format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")`). A total of `r nrow(for.kable)` countries had COVID-19 reported cases, and `r nrow(for.kable[for.kable$cumsum.cases>100,])` countries had more than 100 reported cases.

## Number of fatalities vs. time, plot for the top 20 countries based on number of fatalities

```{r fatalities, fig.height=6, fig.width=8}
library(dplyr)
#obtain top 20 country
top20 <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum.deaths) %>%
 arrange(desc(cumsum.deaths))

#plot top 20

require(ggplot2)
require(ggrepel)


g <- ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories, cases>0), 
 aes(dateRep, cumsum.deaths, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$dateRep == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative number of deaths") +
  ggtitle("Top 20 countries - cumulative")
g
## and in log space
g + scale_y_log10()

```



## Number of confirmed cases vs. time, plot for the top 20 countries based on number of confirmed cases

```{r cases, fig.height=6, fig.width=8}
library(dplyr)
#obtain top 20 country
top20 <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum.cases) %>%
 arrange(desc(cumsum.cases))

#plot top 20

require(ggplot2)
require(ggrepel)


g <- ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories, cases>0), 
 aes(dateRep, cumsum.cases, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$dateRep == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")
g
## and in log space
g + scale_y_log10()

```

## Number of active cases vs. cumulative

This [YouTube video](https://www.youtube.com/watch?v=54XLXg4fYsc&feature=youtu.be&fbclid=IwAR2SRKtyPt9AuW-JPh4jn1E4Fk4s2rRRqPCvM_X6t62Bxgg9ulDV-HJrbfg) makes a number of great suggestions to look at the COVID-19 information on confirmed cases. One suggestion is to plot the number of new cases as a function of the cumulative number of cases and to use a log scale on both axes.

```{r, fig.height=6, fig.width=8}


g <- 
  ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories, cases>0), aes(cumsum.cases, cases)) +
  geom_line(aes(group=countriesAndTerritories, color=countriesAndTerritories)) +
  scale_x_log10() +
  scale_y_log10()
g
```


## Number of confirmed cases, as a table

```{r, results="asis"}
library(knitr)
vars <- c("countriesAndTerritories", "cumsum.cases","cumsum.deaths", "cases.per.e06", "deaths.per.e06", "death.rate.percent"
)
kable(cbind(rank=1:nrow(for.kable),for.kable[,vars]), row.names = FALSE)
```


An alternative is to present the number of cumulative cases starting on the date when 100 or more cases were recorded in each country, and also to use a logarithmic scale for the y axis. 

```{r, fig.height=6, fig.width=8}
first.day.100 <- aggregate(dateRep~countriesAndTerritories, data=df[which(df$cumsum.cases>=100),],min)
d2 <- merge(df, first.day.100, by="countriesAndTerritories")
d2$days.since.100 <- d2$dateRep.x - d2$dateRep.y

n <- d2 %>% filter(dateRep.x == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(20, cumsum.cases) %>%
 arrange(desc(cumsum.cases))


#plot top 20

g<-
d2 %>%
  filter(countriesAndTerritories %in% n$countriesAndTerritories, as.numeric(d2$days.since.100)>0) %>%
  ggplot(aes(as.numeric(days.since.100), cumsum.cases, group=countriesAndTerritories, color=countriesAndTerritories)) +
 geom_line() +
 theme_minimal(base_size=14) +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")

#g
# and in log space
g + scale_y_log10()

```



## A few countries in more details
Before fitting exponential and logistic growth models to the available data, let's look at a few countries separately.

Show the number of cumulative confirmed cases for a number of countries, sharing the same x axis from January 1st 2020 to the present.

```{r, fig.asp=5}

countries <- c("Japan","China","United States","Canada","Spain","Italy","France","Germany","Czechia","Norway","Australia","Argentina","Morocco","South Korea","Iran","Switzerland","Russia","Denmark","Singapore","Israel","United Kingdom","Chile")

this.data <- df[which(df$countriesAndTerritories %in% countries & df$cumsum.cases>100),]

ggplot(this.data,
 aes(dateRep, cumsum.cases)) +
 geom_line() + 
 scale_y_log10() + 
  facet_wrap(~countriesAndTerritories, ncol=2, scales="free_y")

```

## Fitting models
Fit exponential and logistic models to the data to see whether some countries are seeing a decrease in the number of cases. Let's take South Korea, the United States and Canada as examples to start.

```{r}
my.logistic <- function(a=90, b=0.1, c=1E03, ti){
  out <- c / (1 + (a*exp(-b*ti)))
  return(out)
}
#time <- 0:100
#plot(x=time,y=my.logistic(ti=time))


southkoreadata <- d2 %>%
  filter(countriesAndTerritories == "South_Korea" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep.x,cumsum.cases,cases,days.since.100)

sk.lm <- lm(log(cumsum.cases)~dateRep.x, data=southkoreadata)
sk.lm.pred <- data.frame(dateRep.x=southkoreadata$dateRep, cumsum.cases=exp(fitted(sk.lm)))

sk.logistic <- nls(cumsum.cases ~ my.logistic(a,b,c,as.numeric(days.since.100)), data=southkoreadata, start=list(a=5E03,b=1.2,c=1E04))
sk.logistic.pred <- data.frame(dateRep=southkoreadata$dateRep.x, days.since.100=as.numeric(southkoreadata$days.since.100), cumsum.cases=fitted(sk.logistic))

g <- ggplot(southkoreadata, aes(dateRep.x, cumsum.cases)) +
  geom_line() +
  geom_line(data=sk.lm.pred, aes(dateRep.x, cumsum.cases, color="exponential model"), linetype=2) +
  geom_line(data=sk.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model"), linetype=1) +
  guides(color=guide_legend("Model type")) +
  ggtitle("South Korea")
g

## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
southkoreadata$cases.3day.avg <- NA
oo <- order(southkoreadata$dateRep.x)
southkoreadata <- southkoreadata[oo,] # order by date

days <- seq(from=range(southkoreadata$dateRep.x)[1]+2,to=range(southkoreadata$dateRep.x)[2],1)
for(d in days){
  l1 <- which(southkoreadata$dateRep.x==d)
  southkoreadata[l1,"cases.3day.avg"] <- mean(southkoreadata[l1:(l1-2),"cases"])
}

southkoreadata$R.3day.avg <- southkoreadata$cases.3day.avg / lag(southkoreadata$cases.3day.avg)

ggplot(southkoreadata, aes(dateRep.x, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("South Korea - R values by day, using a 3 day moving average")

## US
usdata <- d2 %>%
  filter(countriesAndTerritories == "United_States_of_America" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep.x,cumsum.cases,cases,days.since.100)
us.lm <- lm(log(cumsum.cases)~dateRep.x, data=usdata)
us.lm.pred <- data.frame(dateRep.x=usdata$dateRep, cumsum.cases=exp(fitted(us.lm)))
#us.logistic 

us.logistic <- nls(cumsum.cases ~ my.logistic(a,b,c,as.numeric(days.since.100)), data=usdata, start=list(a=1E03,b=0.28,c=2E05))

a=1E03
b=0.28
c=2E05
#plot(usdata$days.since.100, usdata$cumsum.cases)
#points(usdata$days.since.100, my.logistic(a,b,c,as.numeric(usdata$days.since.100)), pch=19, col="red")


us.logistic.pred <- data.frame(dateRep=usdata$dateRep.x, days.since.100=as.numeric(usdata$days.since.100), cumsum.cases=fitted(us.logistic))

ggplot(usdata, aes(dateRep.x, cumsum.cases)) +
  geom_line() +
  geom_line(data=us.lm.pred, aes(dateRep.x, cumsum.cases, color="exponential model"), linetype=2) +
 # geom_line(data=sk.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model"), linetype=1) +
  guides(color=guide_legend("Model type")) +
  ggtitle("United States") 


## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
usdata$cases.3day.avg <- NA
oo <- order(usdata$dateRep.x)
usdata <- usdata[oo,] # order by date

days <- seq(from=range(usdata$dateRep.x)[1]+2,to=range(usdata$dateRep.x)[2],1)
for(d in days){
  l1 <- which(usdata$dateRep.x==d)
  usdata[l1,"cases.3day.avg"] <- mean(usdata[l1:(l1-2),"cases"])
}

usdata$R.3day.avg <- usdata$cases.3day.avg / lag(usdata$cases.3day.avg)

ggplot(usdata, aes(dateRep.x, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("United States - R values by day, using a 3 day moving average")


## Canada
canadadata <- d2 %>%
  filter(countriesAndTerritories == "Canada" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep.x,cumsum.cases,cases,days.since.100)
canada.lm <- lm(log(cumsum.cases)~dateRep.x, data=canadadata)
canada.lm.pred <- data.frame(dateRep.x=canadadata$dateRep, cumsum.cases=exp(fitted(canada.lm)))


ggplot(canadadata, aes(dateRep.x, cumsum.cases)) +
  geom_line() +
  geom_line(data=canada.lm.pred, aes(dateRep.x, cumsum.cases, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Canada") 


## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
canadadata$cases.3day.avg <- NA
oo <- order(canadadata$dateRep.x)
canadadata <- canadadata[oo,] # order by date

days <- seq(from=range(canadadata$dateRep.x)[1]+2,to=range(canadadata$dateRep.x)[2],1)
for(d in days){
  l1 <- which(canadadata$dateRep.x==d)
  canadadata[l1,"cases.3day.avg"] <- mean(canadadata[l1:(l1-2),"cases"])
}

canadadata$R.3day.avg <- canadadata$cases.3day.avg / lag(canadadata$cases.3day.avg)

ggplot(canadadata, aes(dateRep.x, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("Canada - R values by day, using a 3 day moving average")

```



## Number of cases per million people
Order by decreasing number of cases per one million people. The top of this list is composed of places with small populations.


```{r}
#df$cumsum.cases.per.e06 <- (df$cumsum.cases / df$popData2018) * 1E06
per.capita <- df %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) 

ggplot(per.capita, aes(cases.per.e06)) +
  geom_histogram()

vars<-c("dateRep","countriesAndTerritories","cumsum.cases","popData2018","cases.per.e06")
kable(per.capita[order(per.capita$cases.per.e06,decreasing=TRUE),vars])

```

