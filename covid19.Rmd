---
title: "Notebook of COVID-19 analyses"
author: "Daniel Ricard (daniel.ricard@gmail.com)"
date: '`r paste0("Last modified timestap: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S"))`'
output: html_notebook
---

# Context
Notes about analyses of COVID-19 data. 

# Worldwide cases
Using information made available from the [European Centre for Disease Prevention and Control](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide).


```{r}
## this is copied and pasted from the ECDC website

#these libraries need to be loaded
library(utils)
library(httr)

#download the dataset from the ECDC website to a local temporary file
GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))

#read the Dataset sheet into “R”. The dataset will be called "data".
data <- read.csv(tf)

## DR
data$dateRep <- as.Date(data$dateRep, format="%d/%m/%Y") ## DR, incoming data is formatted day/month/year and was not recognised correctly as a date
## compute the cumulative number of cases by country
library(dplyr)
df <- data[order(data$countriesAndTerritories, data$dateRep),] %>% group_by(countriesAndTerritories) %>% mutate(cumsum = cumsum(cases))

```


## Number of confirmed cases vs. time, plot for the top 20 countries based on number of confirmed cases

```{r, fig.height=6, fig.width=8}
library(dplyr)
#obtain top 20 country
top20 <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum) %>%
 arrange(desc(cumsum))

#plot top 20

require(ggplot2)
require(ggrepel)


g <- ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories), 
 aes(dateRep, cumsum, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$dateRep == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")
g
## and in log space
g + scale_y_log10()

```

## Number of active cases vs. cumulative

This [YouTube video](https://www.youtube.com/watch?v=54XLXg4fYsc&feature=youtu.be&fbclid=IwAR2SRKtyPt9AuW-JPh4jn1E4Fk4s2rRRqPCvM_X6t62Bxgg9ulDV-HJrbfg) makes a number of great suggestions to look at the COVID-19 information on confirmed cases. One suggestion is to plot the number of new cases as a function of the cumulative number of cases and to use a log scale on both axes.

```{r, fig.height=6, fig.width=8}


g <- 
  ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories, cases>0), aes(cumsum, cases)) +
  geom_line(aes(group=countriesAndTerritories, color=countriesAndTerritories)) +
  scale_x_log10() +
  scale_y_log10()
g
```


## Number of confirmed cases, as a table

```{r}
for.kable <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 arrange(desc(cumsum))
```

There were `r sum(for.kable$cumsum)` confirmed cases as this document was generated (`r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`). A total of `r nrow(for.kable)` countries had COVID-19 reported cases, and `r nrow(for.kable[for.kable$cumsum>100,])` countries had more than 100 reported cases.

```{r, results="asis", fig.cap="Cumulative number of confirmed COVID-19 cases by country."}
library(knitr)
vars <- c("countriesAndTerritories", "cumsum")
kable(cbind(rank=1:nrow(for.kable),for.kable[,vars]), row.names = FALSE)
```


An alternative is to present the number of cumulative cases starting on the date when 100 or more cases were recorded in each country, and also to use a logarithmic scale for the y axis. 

```{r, fig.height=6, fig.width=8}
first.day.100 <- aggregate(dateRep~countriesAndTerritories, data=df[which(df$cumsum>=100),],min)
d2 <- merge(df, first.day.100, by="countriesAndTerritories")
d2$days.since.100 <- d2$dateRep.x - d2$dateRep.y

n <- d2 %>% filter(dateRep.x == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(20, cumsum) %>%
 arrange(desc(cumsum))


#plot top 20

g<-
d2 %>%
  filter(countriesAndTerritories %in% n$countriesAndTerritories, as.numeric(d2$days.since.100)>0) %>%
  ggplot(aes(as.numeric(days.since.100), cumsum, group=countriesAndTerritories, color=countriesAndTerritories)) +
 geom_line() +
 theme_minimal(base_size=14) +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")

#g
# and in log space
g + scale_y_log10()

```



## A few countries in more details
Before fitting exponential and logistic growth models to the available data, let's look at a few countries separately.

Show the number of cumulative confirmed cases for a number of countries, sharing the same x axis from January 1st 2020 to the present.

```{r, fig.asp=5}

countries <- c("Japan","China","United States","Canada","Spain","Italy","France","Germany","Czechia","Norway","Australia","Argentina","Morocco","South Korea","Iran","Switzerland","Russia","Denmark","Singapore","Israel","United Kingdom")

this.data <- df[which(df$countriesAndTerritories %in% countries & df$cumsum>100),]

ggplot(this.data,
 aes(dateRep, cumsum)) +
 geom_line() + 
 scale_y_log10() + 
  facet_wrap(~countriesAndTerritories, ncol=2, scales="free_y")

```


Number of cases per one million people. The top of this list is composed of places with small populations.


```{r}
df$cumsum.per.e06 <- (df$cumsum / df$popData2018) * 1E06
per.capita <- df %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) 

ggplot(per.capita, aes(cumsum.per.e06)) +
  geom_histogram()

vars<-c("dateRep","countriesAndTerritories","cumsum","popData2018","cumsum.per.e06")
kable(per.capita[order(per.capita$cumsum.per.e06,decreasing=TRUE),vars])

```

