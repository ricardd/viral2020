---
title: "Notebook of COVID-19 analyses"
author: "Daniel Ricard (daniel.ricard@gmail.com)"
date: '`r paste0("Last modified timestap: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"))`'
output: html_notebook
---

# Context
Notes about analyses of COVID-19 data. Inspired by [an article on Towards Data Science](https://towardsdatascience.com/visualize-the-pandemic-with-r-covid-19-c3443de3b4e4). This document is an R markdown notebook available from my personal [viral2020 GitHub repository](https://github.com/ricardd/viral2020/).

# Worldwide cases and mortalities
Using information made available from the [European Centre for Disease Prevention and Control](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide) and updated on a daily basis. There are likely other sources that are updated more regularly (e.g. the many sources used by [worldometers](https://www.worldometers.info/coronavirus/)), but this is a decent starting point.

```{r, include=FALSE}
## this is copied and pasted from the ECDC website

#these libraries need to be loaded
library(utils)
library(httr)

#download the dataset from the ECDC website to a local temporary file
GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))

#read the Dataset sheet into “R”. The dataset will be called "data".
data <- read.csv(tf)
names(data)[1] <- "dateRep"
## DR
data$dateRep <- as.Date(data$dateRep, format="%d/%m/%Y") ## DR, incoming data is formatted day/month/year and was not recognised correctly as a date
## compute the cumulative number of cases by country
## compute the cumulative number of fatalities by country
library(dplyr)
df <- data[order(data$countriesAndTerritories, data$dateRep),] %>% group_by(countriesAndTerritories) %>% mutate(cumsum.cases = cumsum(cases)) %>% mutate(cumsum.deaths = cumsum(deaths))
df$death.rate.percent <- 100*(df$cumsum.deaths / df$cumsum.cases)
df$cases.per.e06 <- (df$cumsum.cases / df$popData2018)*1E06
df$deaths.per.e06 <- (df$cumsum.deaths / df$popData2018)*1E06
```

```{r, include=FALSE}
## https://datahub.io/JohnSnowLabs/country-and-continent-codes-list
continent.df <- read.csv("country-and-continent-codes-list-csv_csv.txt")

```

```{r, echo=FALSE}
## a table showing today's number of cases in decreasing order
for.kable <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 arrange(desc(cumsum.cases))
```

Worldwide, there were `r format(sum(for.kable$cumsum.cases),big.mark=",")` confirmed cases and `r format(sum(for.kable$cumsum.deaths),big.mark=",")` deaths as this document was generated using the data obtained from the ECDC (HTML document generated `r format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z")`). A total of `r nrow(for.kable)` countries had COVID-19 reported cases, and `r nrow(for.kable[for.kable$cumsum.cases>100,])` countries had more than 100 reported cases.

## Number of new deaths vs. cumulative deaths

This [YouTube video](https://www.youtube.com/watch?v=54XLXg4fYsc&feature=youtu.be&fbclid=IwAR2SRKtyPt9AuW-JPh4jn1E4Fk4s2rRRqPCvM_X6t62Bxgg9ulDV-HJrbfg) makes a number of great suggestions to look at the COVID-19 information on confirmed cases and fatalities. One suggestion is to plot the number of new deaths or cases as a function of the cumulative number of deaths or cases and to use a log scale on both axes. So let's do this for the number of deaths in the 10 countries with the most fatalities.

```{r, fig.height=6, fig.width=8, echo=FALSE}
library(dplyr)
#obtain top 20 and 10 country for fatalities
top20.deaths <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum.deaths) %>%
 arrange(desc(cumsum.deaths))

top10.deaths <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=10, wt=cumsum.deaths) %>%
 arrange(desc(cumsum.deaths))

library(ggplot2)
g <- 
  ggplot(filter(df, countriesAndTerritories %in% top10.deaths$countriesAndTerritories, deaths>0, cumsum.deaths>=10), aes(cumsum.deaths, deaths)) +
  geom_line(aes(group=countriesAndTerritories, color=countriesAndTerritories)) +
  scale_x_log10() +
  scale_y_log10()
g
```

And the same but using the number of confirmed cases instead.

```{r, fig.height=6, fig.width=8, echo=FALSE}
#obtain top 20 and 10 country for fatalities
top20.cases <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum.cases) %>%
 arrange(desc(cumsum.cases))

top10.cases <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=10, wt=cumsum.cases) %>%
 arrange(desc(cumsum.cases))

g <- 
  ggplot(filter(df, countriesAndTerritories %in% top20.cases$countriesAndTerritories, cases>0), aes(cumsum.cases, cases)) +
  geom_line(aes(group=countriesAndTerritories, color=countriesAndTerritories)) +
  scale_x_log10() +
  scale_y_log10()
g
```

Now do the same thing with fatalities.


## Number of fatalities vs. time, plot for the top 20 countries based on number of fatalities

```{r fatalities, fig.height=6, fig.width=8, echo=FALSE}
#plot top 20

require(ggplot2)
require(ggrepel)


g <- ggplot(filter(df, countriesAndTerritories %in% top20.deaths$countriesAndTerritories, cases>0), 
 aes(dateRep, cumsum.deaths, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$dateRep == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative number of deaths") +
  ggtitle("Top 20 countries - cumulative number of deaths")
g
## and in log space
g + scale_y_log10()

```



## Number of confirmed cases vs. time, plot for the top 20 countries based on number of confirmed cases

```{r cases, fig.height=6, fig.width=8, echo=FALSE}
library(dplyr)
#obtain top 20 country
#plot top 20

require(ggplot2)
require(ggrepel)


g <- ggplot(filter(df, countriesAndTerritories %in% top20.cases$countriesAndTerritories, cases>0), 
 aes(dateRep, cumsum.cases, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$dateRep == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative number of cases")
g
## and in log space
g + scale_y_log10()

```

An alternative is to present the number of cumulative cases starting on the date when 100 or more cases were recorded in each country, and use a logarithmic scale for the y axis. 

```{r, fig.height=6, fig.width=8, echo=FALSE}
first.day.100.cases <- aggregate(dateRep~countriesAndTerritories, data=df[which(df$cumsum.cases>=100),],min)
first.day.10.deaths <- aggregate(dateRep~countriesAndTerritories, data=df[which(df$cumsum.deaths>=10),],min)
df2 <- merge(merge(df, first.day.100.cases, by="countriesAndTerritories"), first.day.10.deaths, by="countriesAndTerritories")
names(df2)[c(2,16,17)] <- c("dateRep","date.first.100.cases","date.first.10.deaths")
df2$days.since.100.cases <- df2$dateRep - df2$date.first.100.cases
df2$days.since.10.deaths <- df2$dateRep - df2$date.first.10.deaths


n <- df2 %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(20, cumsum.cases) %>%
 arrange(desc(cumsum.cases))

g<-
df2 %>%
  filter(countriesAndTerritories %in% n$countriesAndTerritories, as.numeric(df2$days.since.100.cases)>0) %>%
  ggplot(aes(as.numeric(days.since.100.cases), cumsum.cases, group=countriesAndTerritories, color=countriesAndTerritories)) +
 geom_line() +
 theme_minimal(base_size=14) +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")

#g
# and in log space
g + scale_y_log10()

```




## Country-level summaries
How are different countries doing? I am testing a function that takes a country as an argument and fits both an exponential growth and a logistic growth model to the number of cumulative cases.

```{r}
my.logistic.fct <- function(a=100, b=0.1, c=1E03, ti){
  out <- c / (1 + (((c-a)/a)*exp(-b*ti)))
  return(out)
}

country.cases.fct <- function(g.id){
  this.df <- filter(df2, geoId==g.id, cumsum.cases>100)

  ## 1500 cases per one million as a starting value for the asymptote c
  c.init <- 1500 * (unique(this.df$popData2018)/1E06)
  #a.init <- c.init/100
    
  my.lm <- lm(log(cumsum.cases)~days.since.100.cases, data=this.df)
  pred.lm <- data.frame(dateRep=this.df$dateRep, cumsum.cases=exp(fitted(my.lm)))
  
  my.logistic <- nls(cumsum.cases ~ my.logistic.fct(a=100, b,c,as.numeric(days.since.100.cases)), data=this.df, start=list(b=0.34,c=c.init))
  logistic.pred <- data.frame(dateRep=this.df$dateRep, days.since.100.cases=as.numeric(this.df$days.since.100.cases), cumsum.cases=fitted(my.logistic))
  ## inflection point
  t50 <- (log((coef(my.logistic)[2]-100)/100) - log(1))/coef(my.logistic)[1]
  n50 <- my.logistic.fct(a=100, coef(my.logistic)[1], coef(my.logistic)[2], ti=t50)
  logistic.text <- paste0("Inflection point: ", round(t50,0), " days and ", round(n50,0), " cases")
  
  country.name <- paste0(as.character(unique(this.df$countriesAndTerritories)), " - ", format(max(this.df$cumsum.cases),big.mark=","), " cumulative cases")
    
  
  g<-ggplot(this.df, aes(dateRep, cumsum.cases)) +
    geom_line(aes(color="data")) +
    geom_point(aes(color="data")) +
    geom_line(data=pred.lm, aes(dateRep, cumsum.cases, color="exponential model"), linetype=2) +
    geom_line(data=logistic.pred, aes(dateRep, cumsum.cases, color="logistic model"), linetype=1) +
    guides(color=guide_legend("Model type")) +
    ggtitle(country.name) +
    geom_point(aes(x=min(dateRep)+t50, y=n50)) +
    annotate("text",x=min(this.df$dateRep)+(as.numeric(diff(range(this.df$dateRep)))*0.4), y=n50, label=logistic.text) +
    ylim(0,max(this.df$cumsum.cases)*1.2)

  g
    
}


country.deaths.fct <- function(g.id){
  this.df <- filter(df2, geoId==g.id, cumsum.deaths>10)

  ## 15 deaths per one million as a starting value for the asymptote c
  c.init <- 15 * (unique(this.df$popData2018)/1E06)
  #a.init <- c.init/100
    
  my.lm <- lm(log(cumsum.deaths)~days.since.10.deaths, data=this.df)
  pred.lm <- data.frame(dateRep=this.df$dateRep, cumsum.deaths=exp(fitted(my.lm)))
  
  my.logistic <- nls(cumsum.deaths ~ my.logistic.fct(a=10, b,c,as.numeric(days.since.10.deaths)), data=this.df, start=list(b=0.34,c=c.init))
  logistic.pred <- data.frame(dateRep=this.df$dateRep, days.since.10.deaths=as.numeric(this.df$days.since.10.deaths), cumsum.deaths=fitted(my.logistic))
  ## inflection point
  t50 <- (log((coef(my.logistic)[2]-10)/10) - log(1))/coef(my.logistic)[1]
  n50 <- my.logistic.fct(a=10, coef(my.logistic)[1], coef(my.logistic)[2], ti=t50)
  logistic.text <- paste0("Inflection point: ", round(t50,0), " days and ", round(n50,0), " deaths")
  
  country.name <- paste0(as.character(unique(this.df$countriesAndTerritories)), " - ", format(max(this.df$cumsum.deaths),big.mark=","), " cumulative deaths")
    
  
  g<-ggplot(this.df, aes(dateRep, cumsum.deaths)) +
    geom_line(aes(color="data")) +
    geom_point(aes(color="data")) +
    geom_line(data=pred.lm, aes(dateRep, cumsum.deaths, color="exponential model"), linetype=2) +
    geom_line(data=logistic.pred, aes(dateRep, cumsum.deaths, color="logistic model"), linetype=1) +
    guides(color=guide_legend("Model type")) +
    ggtitle(country.name) +
    geom_point(aes(x=min(dateRep)+t50, y=n50)) +
    annotate("text",x=min(this.df$dateRep)+(as.numeric(diff(range(this.df$dateRep)))*0.4), y=n50, label=logistic.text) +
    ylim(0,max(this.df$cumsum.deaths)*1.2)

  g
    
}

country.deaths.fct("IT")
country.deaths.fct("ES")
country.deaths.fct("US")
country.deaths.fct("FR")
country.deaths.fct("IR")
country.deaths.fct("UK")



country.cases.fct("US")
country.cases.fct("IT")
country.cases.fct("ES")
country.cases.fct("CN")
country.cases.fct("DE")
country.cases.fct("FR")
country.cases.fct("IR")
country.cases.fct("UK")
country.cases.fct("CH")
country.cases.fct("TR")
country.cases.fct("BE")
country.cases.fct("NL")
country.cases.fct("AT")
country.cases.fct("KR")
country.cases.fct("CA")
country.cases.fct("PT")
#country.cases.fct("BR")
country.cases.fct("IL")
#country.cases.fct("AU")
country.cases.fct("NO")

country.cases.fct("CZ")



#test.df <- data.frame(
#  ti=0:50)
#test.df$y <- my.logistic.fct(a=10, b=0.2, c=1E03, ti=test.df$ti)

#(log(100) - log(1))/0.2
#test.df[test.df$ti==23,]
```


## Number of confirmed cases, as a table

```{r, results="asis", echo=FALSE}
library(knitr)
vars <- c("countriesAndTerritories", "cumsum.cases","cumsum.deaths", "popData2018", "cases.per.e06", "deaths.per.e06", "death.rate.percent"
)
kable(cbind(rank=1:nrow(for.kable),for.kable[,vars]), row.names = FALSE)
```





## A few countries plotted separately
Show the number of cumulative confirmed cases for a number of countries, sharing the same x axis from January 1st 2020 to the present.

```{r, fig.asp=5}

countries <- c("Japan","China","United States","Canada","Spain","Italy","France","Germany","Czechia","Norway","Australia","Argentina","Morocco","South Korea","Iran","Switzerland","Russia","Denmark","Singapore","Israel","United Kingdom","Chile")

this.data <- df[which(df$countriesAndTerritories %in% countries & df$cumsum.cases>100),]

ggplot(this.data,
 aes(dateRep, cumsum.cases)) +
 geom_line() + 
 scale_y_log10() + 
  facet_wrap(~countriesAndTerritories, ncol=2, scales="free_y")

```

## Fitting models
Fit exponential and logistic models to the data to see whether some countries are seeing a decrease in the number of cases. Let's take South Korea, the United States and Canada as examples to start.

```{r}
my.logistic.fct <- function(a=100, b=0.1, c=1E03, ti){
  out <- c / (1 + (((c-a)/a)*exp(-b*ti)))
  return(out)
}

#time <- 0:100
#plot(x=time,y=my.logistic(ti=time))


southkoreadata <- df2 %>%
  filter(countriesAndTerritories == "South_Korea" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep,cumsum.cases,cases,days.since.100.cases)

sk.lm <- lm(log(cumsum.cases)~dateRep, data=southkoreadata)
sk.lm.pred <- data.frame(dateRep=southkoreadata$dateRep, cumsum.cases=exp(fitted(sk.lm)))

sk.logistic <- nls(cumsum.cases ~ my.logistic.fct(a=100,b,c,as.numeric(days.since.100.cases)), data=southkoreadata, start=list(b=1.2,c=1E04))
sk.logistic.pred <- data.frame(dateRep=southkoreadata$dateRep, days.since.100.cases=as.numeric(southkoreadata$days.since.100.cases), cumsum.cases=fitted(sk.logistic))

g <- ggplot(southkoreadata, aes(dateRep, cumsum.cases)) +
  geom_line(aes(color="data")) +
  geom_point(aes(color="data")) +
  geom_line(data=sk.lm.pred, aes(dateRep, cumsum.cases, color="exponential model"), linetype=2) +
  geom_line(data=sk.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model"), linetype=1) +
  guides(color=guide_legend("Model type")) +
  ggtitle("South Korea")
g

## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
southkoreadata$cases.3day.avg <- NA
oo <- order(southkoreadata$dateRep)
southkoreadata <- southkoreadata[oo,] # order by date

days <- seq(from=range(southkoreadata$dateRep)[1]+2,to=range(southkoreadata$dateRep)[2],1)
for(d in days){
  l1 <- which(southkoreadata$dateRep==d)
  southkoreadata[l1,"cases.3day.avg"] <- mean(southkoreadata[l1:(l1-2),"cases"])
}

southkoreadata$R.3day.avg <- southkoreadata$cases.3day.avg / lag(southkoreadata$cases.3day.avg)

ggplot(southkoreadata, aes(dateRep, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("South Korea - R values by day, using a 3 day moving average")

## US
usdata <- df2 %>%
  filter(countriesAndTerritories == "United_States_of_America" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep,cumsum.cases,cases,days.since.100.cases)
us.lm <- lm(log(cumsum.cases)~dateRep, data=usdata)
us.lm.pred <- data.frame(dateRep=usdata$dateRep, cumsum.cases=exp(fitted(us.lm)))
#us.logistic 

us.logistic <- nls(cumsum.cases ~ my.logistic.fct(a=100,b,c,as.numeric(days.since.100.cases)), data=usdata, start=list(b=0.28,c=1E06))
us.logistic.pred <- data.frame(dateRep=usdata$dateRep, days.since.100.cases=as.numeric(usdata$days.since.100.cases), cumsum.cases=fitted(us.logistic))
long.df <- data.frame(days.since.100.cases=0:60)
us.logistic.pred.long <-data.frame(dateRep=seq(min(usdata$dateRep),min(usdata$dateRep)+60,1), days.since.100.cases=0:60, cumsum.cases=my.logistic.fct(a=100, b=coef(us.logistic)[1], c=coef(us.logistic)[2], ti=long.df$days.since.100.cases))

ggplot(usdata, aes(dateRep, cumsum.cases)) +
  geom_line(aes(color="data")) +
  geom_point(aes(color="data")) +
  geom_line(data=us.lm.pred, aes(dateRep, cumsum.cases, color="exponential model"), linetype=2) +
  geom_line(data=us.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model - fit"), linetype=1) +
  geom_line(data=us.logistic.pred.long, aes(dateRep, cumsum.cases, color="logistic model - prediction"), linetype=2) +
  xlim(min(usdata$dateRep),min(usdata$dateRep)+60) +
  guides(color=guide_legend("Model type")) +
  ggtitle("United States") 


## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
usdata$cases.3day.avg <- NA
oo <- order(usdata$dateRep)
usdata <- usdata[oo,] # order by date

days <- seq(from=range(usdata$dateRep)[1]+2,to=range(usdata$dateRep)[2],1)
for(d in days){
  l1 <- which(usdata$dateRep==d)
  usdata[l1,"cases.3day.avg"] <- mean(usdata[l1:(l1-2),"cases"])
}

usdata$R.3day.avg <- usdata$cases.3day.avg / lag(usdata$cases.3day.avg)

ggplot(usdata, aes(dateRep, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("United States - R values by day, using a 3 day moving average")


## Canada
canadadata <- df2 %>%
  filter(countriesAndTerritories == "Canada" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep,cumsum.cases,cases,days.since.100.cases)
canada.lm <- lm(log(cumsum.cases)~dateRep, data=canadadata)
canada.lm.pred <- data.frame(dateRep=canadadata$dateRep, cumsum.cases=exp(fitted(canada.lm)))

canada.logistic <- nls(cumsum.cases ~ my.logistic.fct(a=100,b,c,as.numeric(days.since.100.cases)), data=canadadata, start=list(b=0.3,c=1E04))
canada.logistic.pred <- data.frame(dateRep=canadadata$dateRep, days.since.100.cases=as.numeric(canadadata$days.since.100.cases), cumsum.cases=fitted(canada.logistic))

long.df <- data.frame(days.since.100.cases=0:60)
canada.logistic.pred.long <-data.frame(dateRep=seq(min(canadadata$dateRep),min(canadadata$dateRep)+60,1), days.since.100.cases=0:60, cumsum.cases=my.logistic.fct(a=100, b=coef(canada.logistic)[1], c=coef(canada.logistic)[2], ti=long.df$days.since.100.cases))

ggplot(canadadata, aes(dateRep, cumsum.cases)) +
  geom_line(aes(color="data")) +
  geom_point(aes(color="data")) +
  geom_line(data=canada.lm.pred, aes(dateRep, cumsum.cases, color="exponential model"), linetype=2) +
  geom_line(data=canada.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model - fit"), linetype=1, lwd=1.2) +
  geom_line(data=canada.logistic.pred.long, aes(dateRep, cumsum.cases, color="logistic model - prediction"), linetype=2) +
  xlim(min(canadadata$dateRep),min(canadadata$dateRep)+60) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Canada") 


## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
canadadata$cases.3day.avg <- NA
oo <- order(canadadata$dateRep)
canadadata <- canadadata[oo,] # order by date

days <- seq(from=range(canadadata$dateRep)[1]+2,to=range(canadadata$dateRep)[2],1)
for(d in days){
  l1 <- which(canadadata$dateRep==d)
  canadadata[l1,"cases.3day.avg"] <- mean(canadadata[l1:(l1-2),"cases"])
}

canadadata$R.3day.avg <- canadadata$cases.3day.avg / lag(canadadata$cases.3day.avg)

ggplot(canadadata, aes(dateRep, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("Canada - R values by day, using a 3 day moving average")


## Italy
italydata <- df2 %>%
  filter(countriesAndTerritories == "Italy" & cumsum.cases>100) %>%
  select(countriesAndTerritories,dateRep,cumsum.cases,cases,days.since.100.cases)
italy.lm <- lm(log(cumsum.cases)~dateRep, data=italydata)
italy.lm.pred <- data.frame(dateRep=italydata$dateRep, cumsum.cases=exp(fitted(italy.lm)))

italy.logistic <- nls(cumsum.cases ~ my.logistic.fct(a=100,b,c,as.numeric(days.since.100.cases)), data=italydata, start=list(b=0.7,c=3E05))
italy.logistic.pred <- data.frame(dateRep=italydata$dateRep, days.since.100.cases=as.numeric(italydata$days.since.100.cases), cumsum.cases=fitted(italy.logistic))


ggplot(italydata, aes(dateRep, cumsum.cases)) +
  geom_line(aes(color="data")) +
  geom_point(aes(color="data")) +
  geom_line(data=italy.lm.pred, aes(dateRep, cumsum.cases, color="exponential model"), linetype=2) +
  geom_line(data=italy.logistic.pred, aes(dateRep, cumsum.cases, color="logistic model"), linetype=1) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Italy") 


## what is the daily change in the number of new cases, once the number of daily cases is smoothed out to a 3-day moving average?
italydata$cases.3day.avg <- NA
oo <- order(italydata$dateRep)
italydata <- italydata[oo,] # order by date

days <- seq(from=range(italydata$dateRep)[1]+2,to=range(italydata$dateRep)[2],1)
for(d in days){
  l1 <- which(italydata$dateRep==d)
  italydata[l1,"cases.3day.avg"] <- mean(italydata[l1:(l1-2),"cases"])
}

italydata$R.3day.avg <- italydata$cases.3day.avg / lag(italydata$cases.3day.avg)

ggplot(italydata, aes(dateRep, R.3day.avg)) +
  geom_line() + 
  geom_hline(yintercept = 1, lty=2) +
  ylim(0,1.8) +
  ggtitle("Italy - R values by day, using a 3 day moving average")

```



## Number of cases per million people
Order by decreasing number of cases per one million people. The top of this list is composed of places with small populations.


```{r}
#df$cumsum.cases.per.e06 <- (df$cumsum.cases / df$popData2018) * 1E06
per.capita <- df %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) 

ggplot(per.capita, aes(cases.per.e06)) +
  geom_histogram()

vars<-c("dateRep","countriesAndTerritories","cumsum.cases","popData2018","cases.per.e06")
kable(per.capita[order(per.capita$cases.per.e06,decreasing=TRUE),vars])

```

