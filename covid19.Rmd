---
title: "Notebook of COVID-19 analyses"
author: "Daniel Ricard (daniel.ricard@gmail.com)"
date: '`r paste0("Last modified timestap: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S"))`'
output: html_notebook
---

# Context
Notes about analyses of COVID-19 data. Thank you to 
Xinhan Qian for her article in [Towards Data Science](https://towardsdatascience.com/visualize-the-pandemic-with-r-covid-19-c3443de3b4e4) that I used as a starting point for this notebook.

There has been a lot of emphasis about "flattening the curve" in the media and in motivating public health measures. However, the most common type of plot presented shows the cumulative number of cases over time, whereas the "curve" that needs to be flattened is when looking at the number of NEW cases over time. So I will be generating both plots below.



# Worldwide cases
Using information made available from the [European Centre for Disease Prevention and Control](https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide).


```{r}
#these libraries need to be loaded
library(utils)
library(httr)

#download the dataset from the ECDC website to a local temporary file
GET("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", authenticate(":", ":", type="ntlm"), write_disk(tf <- tempfile(fileext = ".csv")))

#read the Dataset sheet into “R”. The dataset will be called "data".
data <- read.csv(tf)
data$dateRep <- as.Date(data$dateRep, format="%d/%m/%Y")

## cumulative number of cases by country
library(dplyr)
df <- data[order(data$countriesAndTerritories, data$dateRep),] %>% group_by(countriesAndTerritories) %>% mutate(cumsum = cumsum(cases))

```


## Number of confirmed cases vs. time, plot for the top 20 countries based on number of confirmed cases

```{r, warning=FALSE}
library(dplyr)
#obtain top 20 country
top20 <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(n=20, wt=cumsum) %>%
 arrange(desc(cumsum))

#plot top 20

require(ggplot2)
require(ggrepel)


ggplot(filter(df, countriesAndTerritories %in% top20$countriesAndTerritories), #df$dateRep > "2020-01-01"),
 aes(dateRep, cumsum, color=countriesAndTerritories)) +
 geom_line() +
 geom_text_repel(aes(label=countriesAndTerritories),
 function(d) d[d$time == format(Sys.time(),"%Y-%m-%d"),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")

```

```{r}

```

## Number of confirmed cases, table

```{r}
for.kable <- ungroup(df) %>% filter(dateRep == format(Sys.time(),"%Y-%m-%d")) %>%
 arrange(desc(cumsum))
```

There were `r sum(for.kable$cumsum)` confirmed cases as this document was generated. This is based on the data obtained above which is only updated once a day.

```{r, results="asis"}
library(knitr)
vars <- c("countriesAndTerritories", "cumsum")
kable(cbind(rank=1:nrow(for.kable),for.kable[,vars]), row.names = FALSE)
```
# Country-specific analyses

Now let's look at a few countries in more details, to see whether their number of cases are diverging from exponential growth.


```{r, fig.asp=5}

countries <- c("Japan","China","United States","Canada","Spain","Italy","France","Germany","Czechia","Norway","Australia","Argentina","Morocco","South Korea","Iran","Switzerland","Russia","Denmark","Singapore","Israel","United Kingdom")

this.data <- df[which(df$countriesAndTerritories %in% countries & df$cumsum>100),]

# lm(log(cum_confirm)~time*country, data=this.data)


ggplot(this.data,
 aes(dateRep, cumsum)) +
 geom_line() + 
#  stat_smooth(method = 'nls', formula = y ~ a*exp(b *x), aes(colour = 'Exponential'), se = FALSE, start = list(a=10,b=1)) +
  facet_wrap(~countriesAndTerritories, ncol=2, scales="free_y")

```

An alternative is to present the number of cumulative cases starting on the date when 100 or more cases were recorded in each country. 

```{r}
first.day.100 <- aggregate(dateRep~countriesAndTerritories, data=df[which(df$cumsum>=100),],min)
d2 <- merge(df, first.day.100, by="countriesAndTerritories")
d2$days.since.100 <- d2$dateRep.x - d2$dateRep.y

n <- d2 %>% filter(dateRep.x == format(Sys.time(),"%Y-%m-%d")) %>%
 top_n(20, cumsum) %>%
 arrange(desc(cumsum))


#plot top 20

ggplot(filter(d2, countriesAndTerritories %in% n$countriesAndTerritories, as.numeric(d2$days.since.100)>0),
 aes(as.numeric(days.since.100), cumsum, color=countriesAndTerritories)) +
 geom_line() +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")


```



## Italy in more details
Italy has been in the news a lot because of the scale of the outbreak in that country. See how the situation is evolving in recent days.

```{r}
italydata <- df %>%
filter(countriesAndTerritories == "Italy" & cumsum>100) %>%
select(dateRep,cumsum,cases)


italydata$R <- italydata$cases / lag(italydata$cases)

plot(R~dateRep, data=italydata, type='l')
abline(a=1,b=0, lty=2)

mean(italydata$R, na.rm = TRUE)

my.lm <- lm(log(cumsum)~dateRep, data=italydata)
lm.pred <- data.frame(dateRep=italydata$dateRep, cumsum=exp(fitted(my.lm)))

my.logistic <- SSA

ggplot(italydata, aes(dateRep, cumsum)) +
  geom_line() +
  geom_line(data=lm.pred, aes(dateRep, cumsum, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Italy")
  

```


## United States in more details
On March 27, the United States became the country with the most cases, so let's see how things are evolving in that country.

```{r}
d <- y['global'] #extract global data
usdata <- d %>%
filter(d$country == "United States" & d$cum_confirm>100) %>%
select(time,cum_confirm)


usdata$new_cases <- usdata$cum_confirm - lag(usdata$cum_confirm)
usdata$R <- usdata$new_cases / lag(usdata$new_cases)

plot(R~time, data=usdata, type='l')
abline(a=1,b=0, lty=2)

mean(usdata$R, na.rm = TRUE)

my.lm <- lm(log(cum_confirm)~time, data=usdata)
lm.pred <- data.frame(time=usdata$time, cum_confirm=exp(fitted(my.lm)))

ggplot(usdata, aes(time, cum_confirm)) +
  geom_line() +
  geom_line(data=lm.pred, aes(time, cum_confirm, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("United States")

```

## Canada in more details
Since I live in Canada, I am also interested in seeing how things are evolving in that country.


```{r}
d <- y['global'] #extract global data
canadadata <- d %>%
filter(d$country == "Canada" & d$cum_confirm>100) %>%
select(time,cum_confirm)



canadadata$new_cases <- canadadata$cum_confirm - lag(canadadata$cum_confirm)
canadadata$R <- canadadata$new_cases / lag(canadadata$new_cases)

plot(R~time, data=canadadata, type='l')
abline(a=1,b=0, lty=2)

mean(canadadata$R, na.rm = TRUE)

my.lm <- lm(log(cum_confirm)~time, data=canadadata)
lm.pred <- data.frame(time=canadadata$time, cum_confirm=exp(fitted(my.lm)))

ggplot(canadadata, aes(time, cum_confirm)) +
  geom_line() +
  geom_line(data=lm.pred, aes(time, cum_confirm, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Canada")

```
