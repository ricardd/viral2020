---
title: "Notebook of COVID-19 analyses"
author: "Daniel Ricard (daniel.ricard@gmail.com)"
date: '`r paste0("Last modified timestap: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S"))`'
output: html_notebook
---

# Context
Notes about analyses of COVID-19 data. Thank you to 
Xinhan Qian for her article in [Towards Data Science](https://towardsdatascience.com/visualize-the-pandemic-with-r-covid-19-c3443de3b4e4) that I used as a starting point for this notebook.

There has been a lot of emphasis about "flattening the curve" in the media and in motivating public health measures. However, the most common type of plot presented shows the cumulative number of cases over time, whereas the "curve" that needs to be flattened is when looking at the number of NEW cases over time. So I will be generating both plots below.



# Worldwide cases

I am using the [nCov2019 R package](http://www.github.com/GuangchuangYu/nCov2019) to extract information about country-specific number of cases.

## Number of confirmed cases vs. time, plot for the top 20 countries based on number of confirmed cases

```{r, warning=FALSE}
# this package provides the data 
# remotes::install_github("GuangchuangYu/nCov2019")
require(nCov2019)
require(dplyr)

x <- get_nCov2019()
y <- load_nCov2019()

y

#library(DataExplorer)
#plot_str(x)

#obtain top 20 country
d <- y['global'] #extract global data
#l1 <- which(d$country != 'China')
#d <- d[l1,] #exclude China
n <- d %>% filter(time == time(y)) %>%
 top_n(20, cum_confirm) %>%
 arrange(desc(cum_confirm))


#plot top 20

require(ggplot2)
require(ggrepel)

ggplot(filter(d, country %in% n$country, d$time > "2020-01-01"),
 aes(time, cum_confirm, color=country)) +
 geom_line() +
 geom_text_repel(aes(label=country),
 function(d) d[d$time == time(y),]) +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")

```

```{r}

```

## Number of confirmed cases, table

```{r}
d <- y['global'] #extract global data
my.agg <- aggregate(cum_confirm~time+country, data=d, sum)
latest.df <- my.agg[my.agg$time == max(my.agg$time),]
oo <- order(latest.df$cum_confirm, decreasing=TRUE)
# format(Sys.time(),"%Y-%m-%d")
```
There were `r sum(latest.df$cum_confirm)` confirmed cases as this document was generated. This is based on the data obtained above which is only updated once a day.


```{r, results="asis"}
library(knitr)
kable(cbind(rank=1:length(oo),latest.df[oo,]), row.names = FALSE)
```
# Country-specific analyses

Now let's look at a few countries in more details, to see whether their number of cases are diverging from exponential growth.


```{r, fig.asp=5}

d <- y['global'] #extract global data
countries <- c("Japan","China","United States","Canada","Spain","Italy","France","Germany","Czechia","Norway","Australia","Argentina","Morocco","South Korea","Iran","Switzerland","Russia","Denmark","Singapore","Israel","United Kingdom")

this.data <- d[which(d$country %in% countries & d$cum_confirm>100),]

# lm(log(cum_confirm)~time*country, data=this.data)


ggplot(this.data,
 aes(time, cum_confirm)) +
 geom_line() + 
#  stat_smooth(method = 'nls', formula = y ~ a*exp(b *x), aes(colour = 'Exponential'), se = FALSE, start = list(a=10,b=1)) +
  facet_wrap(~country, ncol=2, scales="free_y")

```

An alternative is to present the number of cumulative cases starting on the date when 100 or more cases were recorded in each country. 

```{r}
d <- y['global'] #extract global data
first.day.100 <- aggregate(time~country, data=d[which(d$cum_confirm>=100),],min)
d2 <- merge(d, first.day.100, by="country")
d2$days.since.100 <- d2$time.x - d2$time.y

n <- d2 %>% filter(time.x == time(y)) %>%
 top_n(20, cum_confirm) %>%
 arrange(desc(cum_confirm))


#plot top 20

ggplot(filter(d2, country %in% n$country, as.numeric(d2$days.since.100)>0),
 aes(as.numeric(days.since.100), cum_confirm, color=country)) +
 geom_line() +
 theme_minimal(base_size=14) +
 theme(legend.position = "none") +
  ylab("Cumulative confirmed number of cases") +
  ggtitle("Top 20 countries - cumulative")


```



## Italy in more details
Italy has been in the news a lot because of the scale of the outbreak in that country. See how the situation is evolving in recent days.

```{r}
d <- y['global'] #extract global data
italydata <- d %>%
filter(d$country == "Italy" & d$cum_confirm>100) %>%
select(time,cum_confirm)



italydata$new_cases <- italydata$cum_confirm - lag(italydata$cum_confirm)
italydata$R <- italydata$new_cases / lag(italydata$new_cases)

plot(R~time, data=italydata, type='l')
abline(a=1,b=0, lty=2)

mean(italydata$R, na.rm = TRUE)

my.lm <- lm(log(cum_confirm)~time, data=italydata)
lm.pred <- data.frame(time=italydata$time, cum_confirm=exp(fitted(my.lm)))


ggplot(italydata, aes(time, cum_confirm)) +
  geom_line() +
  geom_line(data=lm.pred, aes(time, cum_confirm, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Italy")
  

```


## United States in more details
On March 27, the United States became the country with the most cases, so let's see how things are evolving in that country.

```{r}
d <- y['global'] #extract global data
usdata <- d %>%
filter(d$country == "United States" & d$cum_confirm>100) %>%
select(time,cum_confirm)


usdata$new_cases <- usdata$cum_confirm - lag(usdata$cum_confirm)
usdata$R <- usdata$new_cases / lag(usdata$new_cases)

plot(R~time, data=usdata, type='l')
abline(a=1,b=0, lty=2)

mean(usdata$R, na.rm = TRUE)

my.lm <- lm(log(cum_confirm)~time, data=usdata)
lm.pred <- data.frame(time=usdata$time, cum_confirm=exp(fitted(my.lm)))

ggplot(usdata, aes(time, cum_confirm)) +
  geom_line() +
  geom_line(data=lm.pred, aes(time, cum_confirm, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("United States")

```

## Canada in more details
Since I live in Canada, I am also interested in seeing how things are evolving in that country.


```{r}
d <- y['global'] #extract global data
canadadata <- d %>%
filter(d$country == "Canada" & d$cum_confirm>100) %>%
select(time,cum_confirm)



canadadata$new_cases <- canadadata$cum_confirm - lag(canadadata$cum_confirm)
canadadata$R <- canadadata$new_cases / lag(canadadata$new_cases)

plot(R~time, data=canadadata, type='l')
abline(a=1,b=0, lty=2)

mean(canadadata$R, na.rm = TRUE)

my.lm <- lm(log(cum_confirm)~time, data=canadadata)
lm.pred <- data.frame(time=canadadata$time, cum_confirm=exp(fitted(my.lm)))

ggplot(canadadata, aes(time, cum_confirm)) +
  geom_line() +
  geom_line(data=lm.pred, aes(time, cum_confirm, color="exponential model"), linetype=2) +
  guides(color=guide_legend("Model type")) +
  ggtitle("Canada")

```
